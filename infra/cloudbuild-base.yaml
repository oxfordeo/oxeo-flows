steps:
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    secretEnv:
      - 'SSH'
      - 'PREFECT'
      - 'GCP_TOKEN'
    args:
      - '-c'
      - 'echo $$SSH > key &&
         echo $$GCP_TOKEN > token &&
          docker build .
          --file=infra/Dockerfile.base
          --tag=eu.gcr.io/$PROJECT_ID/base
          --build-arg=PREFECT=$$PREFECT'
images:
  - 'eu.gcr.io/$PROJECT_ID/base'
availableSecrets:
  secretManager:
  - versionName: 'projects/$PROJECT_ID/secrets/github-machine-ssh-key/versions/1'
    env: 'SSH'
  - versionName: 'projects/$PROJECT_ID/secrets/prefect-cloud-api-key/versions/1'
    env: 'PREFECT'
  - versionName: 'projects/$PROJECT_ID/secrets/sat-extractor-gcp-token/versions/1'
    env: 'GCP_TOKEN'
